<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Malla Curricular Multiestudiante - Terapia Ocupacional</title>
  <style>
    body { font-family: Cambria, serif; background-color: #e9f5ec; padding: 15px 10px; color: #2d3e26; }
    h1 { text-align: center; color: #2e7d32; margin-bottom: 20px; font-size: 1.8em; }
    .student-select { margin: 0 auto 20px; max-width: 350px; display: flex; gap:10px; }
    select, input[type=text] { font-size: 1em; padding: 6px; border-radius: 6px; border: 1px solid #ccc; flex: 1; }
    button { background: #388e3c; color: white; border: none; border-radius: 6px; cursor: pointer; padding: 8px 14px; }
    button:hover { background: #2e7d32; }
    .curriculum { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
    .year { min-width: 230px; max-width: 230px; background: #d0e8d0; border-radius: 8px; padding: 12px 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.12); }
    .year h2 { text-align: center; font-size: 1.15em; border-bottom: 2px solid #4caf50; padding-bottom: 6px; margin-bottom: 12px; color: #2e7d32; }
    .semester { margin-bottom: 14px; }
    .semester h3 { font-size: 1em; color: #33691e; margin: 8px 0 6px; border-bottom: 1.5px solid #a5d6a7; padding-bottom: 4px; }
    .subject { padding: 7px 8px; margin: 5px 0; background: #f0faf0; border-left: 5px solid #81c784; border-radius: 5px; cursor: pointer; color: #1b5e20; user-select: none; font-size: 0.9em; position: relative; }
    .subject.approved { background: #4caf50; color: white; border-color: #388e3c; }
    .subject.locked { background: #e0e0e0; color: #9e9e9e; cursor: not-allowed; border-color: #bdbdbd; }
    .subject[title]:hover::after {
      content: attr(title);
      position: absolute;
      left: 105%;
      top: 0;
      background: #2e7d32;
      color: #e8f5e9;
      padding: 6px 8px;
      border-radius: 5px;
      white-space: pre-wrap;
      font-size: 0.75em;
      z-index: 10;
      max-width: 220px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }
    #progress-text { font-weight: bold; text-align: center; margin-bottom: 20px; }
  </style>
</head>
<body>

  <h1>Malla Curricular - Terapia Ocupacional</h1>

  <div class="student-select">
    <select id="studentSelector" title="Selecciona estudiante"></select>
    <input type="text" id="newStudentRut" placeholder="RUT sin puntos ni guion" />
    <input type="text" id="newStudentName" placeholder="Nombre completo" />
    <button onclick="addStudent()">Agregar</button>
  </div>

  <div id="progress-text">Progreso académico: 0%</div>

  <div class="curriculum" id="curriculum"></div>

  <div style="text-align:center; margin-top:20px;">
    <button onclick="resetProgress()">Reiniciar Progreso Estudiante</button>
  </div>

  <script>
    let students = JSON.parse(localStorage.getItem('students') || '{}');
    let currentStudentId = null;

    const curriculum = {
      'Año 1': ['I', 'II'],
      'Año 2': ['III', 'IV'],
      'Año 3': ['V', 'VI'],
      'Año 4': ['VII', 'VIII'],
      'Año 5': ['IX', 'X']
    };

    const subjects = [
      { code: 'MAT-016', name: 'Razonamiento Lógico Matemático', semester: 'I', prereq: [] },
      { code: 'BIO-006', name: 'Principios de la Biología', semester: 'I', prereq: [] },
      { code: 'COM-001', name: 'Taller de Competencias para el Aprendizaje', semester: 'I', prereq: [] },
      { code: 'FGL-149', name: 'Taller de Competencias Comunicativas', semester: 'I', prereq: [] },
      { code: 'TOC-078', name: 'Fundamentos de Terapia Ocupacional', semester: 'I', prereq: [] },
      { code: 'FGL-151', name: 'Taller de Desarrollo Personal I', semester: 'I', prereq: [] },
      { code: 'TOC-079', name: 'Anatomía Descriptiva', semester: 'II', prereq: [] },
      { code: 'TOC-080', name: 'Psicología General y del Desarrollo', semester: 'II', prereq: [] },
      { code: 'TOC-119', name: 'Ocupación Humana', semester: 'II', prereq: ['TOC-078'] },
      { code: 'FGL-152', name: 'Taller de Desarrollo Personal II', semester: 'II', prereq: [] },
      { code: 'FGL-001', name: 'Cultura y Valores', semester: 'II', prereq: [] },
      { code: 'ENF-150', name: 'Salud y Sociedad', semester: 'II', prereq: [] },
      { code: 'ENF-151', name: 'Atención Básica de Urgencia', semester: 'II', prereq: [] },
      { code: 'TOC-083', name: 'Desempeño y Participación Ocupacional', semester: 'III', prereq: ['TOC-119'] },
      { code: 'TOC-006', name: 'Psicología Social y del Trabajo', semester: 'III', prereq: [] },
      { code: 'TOC-084', name: 'Fundamentos del Movimiento Humano', semester: 'III', prereq: ['MAT-016'] },
      { code: 'TOC-085', name: 'Anatomía y Fisiología de Sistemas', semester: 'III', prereq: [] },
      { code: 'TOC-086', name: 'Introducción a la Salud Mental', semester: 'III', prereq: ['TOC-080'] },
      { code: 'FGL-008', name: 'Inglés Básico I', semester: 'III', prereq: [] },
      { code: 'FGL-111', name: 'Persona y Sentido', semester: 'III', prereq: [] },
      { code: 'TOC-087', name: 'Evaluación del Desarrollo de Competencias HITO 1', semester: 'IV', prereq: ['TOC-083'] },
      { code: 'TOC-088', name: 'Análisis y Adaptación de la Actividad', semester: 'IV', prereq: ['TOC-083'] },
      { code: 'ENF-152', name: 'Ética y Salud', semester: 'IV', prereq: [] },
      { code: 'TOC-089', name: 'Psicomotricidad', semester: 'IV', prereq: [] },
      { code: 'TOC-090', name: 'Patología General', semester: 'IV', prereq: [] },
      { code: 'TOC-091', name: 'Biomecánica', semester: 'IV', prereq: ['TOC-084'] },
      { code: 'FGL-010', name: 'Inglés Básico II', semester: 'IV', prereq: ['FGL-008'] },
      { code: 'TOC-092', name: 'Razonamiento Profesional', semester: 'V', prereq: ['TOC-083'] },
      { code: 'TOC-057', name: 'Psicomotricidad Aplicada', semester: 'V', prereq: ['TOC-089'] },
      { code: 'TOC-093', name: 'Gestión y Terapia Ocupacional', semester: 'V', prereq: [] },
      { code: 'TOC-094', name: 'Salud Mental en Niños y Adolescentes', semester: 'V', prereq: ['TOC-086'] },
      { code: 'TOC-095', name: 'Neurología en Niños y Adolescentes', semester: 'V', prereq: ['TOC-089'] },
      { code: 'TOC-096', name: 'Traumatología', semester: 'V', prereq: ['TOC-079'] },
      { code: 'TOC-EL1', name: 'Electivo I', semester: 'V', prereq: [] },
      { code: 'TOC-097', name: 'Procesos de Terapia Ocupacional', semester: 'VI', prereq: ['TOC-092'] },
      { code: 'TOC-098', name: 'Ergonomía y Salud en el Trabajo', semester: 'VI', prereq: ['TOC-088'] },
      { code: 'TOC-099', name: 'Diagnóstico e Intervención en la Comunidad', semester: 'VI', prereq: [] },
      { code: 'TOC-100', name: 'Salud Mental del Adulto y Persona Mayor', semester: 'VI', prereq: ['TOC-086'] },
      { code: 'TOC-101', name: 'Neurología del Adulto y Persona Mayor', semester: 'VI', prereq: ['TOC-085'] },
      { code: 'TOC-EL2', name: 'Electivo II', semester: 'VI', prereq: ['TOC-EL1'] },
      { code: 'TOC-102', name: 'Diagnóstico Ocupacional en Personas Mayores', semester: 'VII', prereq: ['TOC-101','TOC-100','TOC-097'] },
      { code: 'TOC-103', name: 'Diagnóstico Ocupacional en Adultos', semester: 'VII', prereq: ['TOC-101','TOC-100','TOC-097'] },
      { code: 'TOC-104', name: 'Diagnóstico Ocupacional en Niños, Niñas y Adolescentes', semester: 'VII', prereq: ['TOC-094','TOC-097','TOC-095'] },
      { code: 'TOC-068', name: 'Inclusión Educacional y Laboral', semester: 'VII', prereq: ['TOC-094','TOC-095','TOC-098'] },
      { code: 'TOC-105', name: 'Órtesis y Tecnologías para la Inclusión', semester: 'VII', prereq: ['TOC-091','TOC-101','TOC-096'] },
      { code: 'TOC-106', name: 'Estadística y Epidemiología', semester: 'VII', prereq: ['MAT-016'] },
      { code: 'TOC-107', name: 'Evaluación del Desarrollo de Competencias HITO 2', semester: 'VIII', prereq: ['TOC-102','TOC-103','TOC-104'] },
      { code: 'TOC-108', name: 'Intervención Ocupacional en Personas Mayores', semester: 'VIII', prereq: ['TOC-102'] },
      { code: 'TOC-109', name: 'Intervención Ocupacional en Adultos', semester: 'VIII', prereq: ['TOC-103'] },
      { code: 'TOC-110', name: 'Intervención Ocupacional en Niños y Adolescentes', semester: 'VIII', prereq: ['TOC-104'] },
      { code: 'TOC-111', name: 'Órtesis', semester: 'VIII', prereq: ['TOC-105'] },
      { code: 'TOC-EL3', name: 'Electivo III', semester: 'VIII', prereq: ['TOC-EL2'] },
      { code: 'TOC-113', name: 'Metodología y Diseño de Investigación', semester: 'VIII', prereq: ['TOC-106'] },
      { code: 'TOC-114', name: 'Internado Profesional I', semester: 'IX', prereq: ['TOC-107'] },
      { code: 'TOC-115', name: 'Internado Profesional II', semester: 'IX', prereq: ['TOC-107','TOC-114'] },
      { code: 'TOC-116', name: 'Seminario de Investigación', semester: 'IX', prereq: ['TOC-113'] },
      { code: 'TOC-117', name: 'Internado Profesional III', semester: 'X', prereq: ['TOC-107','TOC-115'] },
      { code: 'TOC-118', name: 'Internado Profesional IV', semester: 'X', prereq: ['TOC-107','TOC-117'] }
    ];

    // Poner estudiantes en el selector
    function populateStudentSelector() {
      const select = document.getElementById('studentSelector');
      select.innerHTML = '';
      for (const rut in students) {
        const opt = document.createElement('option');
        opt.value = rut;
        opt.textContent = `${students[rut].name} (${rut})`;
        select.appendChild(opt);
      }
      if (!currentStudentId && select.options.length > 0) {
        currentStudentId = select.options[0].value;
      }
      select.value = currentStudentId;
    }

    document.getElementById('studentSelector').addEventListener('change', e => {
      currentStudentId = e.target.value;
      renderCurriculum();
      updateProgress();
    });

    function addStudent() {
      const rutInput = document.getElementById('newStudentRut');
      const nameInput = document.getElementById('newStudentName');
      const rut = rutInput.value.trim();
      const name = nameInput.value.trim();
      if (!rut || !name) {
        alert('Por favor ingresa RUT y Nombre completos.');
        return;
      }
      if (students[rut]) {
        alert('Este RUT ya existe.');
        return;
      }
      students[rut] = { name, approved: [] };
      currentStudentId = rut;
      rutInput.value = '';
      nameInput.value = '';
      saveStudents();
      populateStudentSelector();
      renderCurriculum();
      updateProgress();
    }

    function saveStudents() {
      localStorage.setItem('students', JSON.stringify(students));
    }

    function isApproved(code) {
      if (!currentStudentId) return false;
      return students[currentStudentId].approved.includes(code);
    }

    function meetsPrerequisites(subject) {
      if (!currentStudentId) return false;
      return subject.prereq.every(code => isApproved(code));
    }

    function allSemestersApproved(uptoSemester) {
      const allowedSemesters = ['I','II','III','IV','V','VI','VII','VIII'];
      const semestersToCheck = allowedSemesters.slice(0, allowedSemesters.indexOf(uptoSemester) + 1);
      const subjectsToCheck = subjects.filter(s => semestersToCheck.includes(s.semester));
      return subjectsToCheck.every(s => isApproved(s.code));
    }

    function renderCurriculum() {
      if (!currentStudentId) {
        document.getElementById('curriculum').innerHTML = '<p>Agrega y selecciona un estudiante.</p>';
        document.getElementById('progress-text').textContent = 'Progreso académico: 0%';
        return;
      }
      const container = document.getElementById('curriculum');
      container.innerHTML = '';

      for (const [yearLabel, semesters] of Object.entries(curriculum)) {
        const yearDiv = document.createElement('div');
        yearDiv.className = 'year';
        yearDiv.innerHTML = `<h2>${yearLabel}</h2>`;

        semesters.forEach(sem => {
          const semDiv = document.createElement('div');
          semDiv.className = 'semester';
          semDiv.innerHTML = `<h3>Semestre ${sem}</h3>`;

          subjects.filter(s => s.semester === sem).forEach(subject => {
            const div = document.createElement('div');

            const unlocked = meetsPrerequisites(subject) && (
              (subject.semester === 'IX' || subject.semester === 'X') ? allSemestersApproved('VIII') : true
            );

            div.className = 'subject';
            div.textContent = subject.name;

            if (isApproved(subject.code)) {
              div.classList.add('approved');
            } else if (!unlocked) {
              div.classList.add('locked');
              const names = subject.prereq.map(p => {
                const found = subjects.find(s => s.code === p);
                return found ? found.name : p;
              });
              let extraMsg = '';
              if (subject.semester === 'IX' || subject.semester === 'X') {
                extraMsg = '\nAdemás, requiere aprobar todos los ramos hasta el VIII semestre.';
              }
              div.title = 'Requiere: ' + (names.length ? names.join(', ') : 'Prerrequisitos no cumplidos') + extraMsg;
            }

            div.onclick = () => {
              if (!unlocked) return;

              const studentData = students[currentStudentId];
              if (studentData.approved.includes(subject.code)) {
                // Quitar aprobado
                studentData.approved = studentData.approved.filter(c => c !== subject.code);
              } else {
                let estado = prompt(`Estado para "${subject.name}": escribe "APR" para aprobado o "REP" para reprobado.`);
                if (estado === null) return;
                estado = estado.trim().toUpperCase();

                if (estado === 'APR') {
                  studentData.approved.push(subject.code);
                } else if (estado === 'REP') {
                  alert('Asignatura marcada como Reprobada.');
                  return;
                } else {
                  alert('Solo "APR" o "REP" válidos.');
                  return;
                }
              }
              saveStudents();
              renderCurriculum();
              updateProgress();
            };

            semDiv.appendChild(div);
          });

          yearDiv.appendChild(semDiv);
        });

        container.appendChild(yearDiv);
      }
    }

    function updateProgress() {
      if (!currentStudentId) {
        document.getElementById('progress-text').textContent = 'Progreso académico: 0%';
        return;
      }
      const approvedCount = students[currentStudentId].approved.length;
      const percent = subjects.length ? Math.round((approvedCount / subjects.length) * 100) : 0;
      document.getElementById('progress-text').textContent = `Progreso académico: ${percent}%`;
    }

    function resetProgress() {
      if (!currentStudentId) {
        alert('Selecciona un estudiante primero.');
        return;
      }
      if (confirm(`¿Quieres reiniciar el progreso de ${students[currentStudentId].name}? Se eliminarán todas las asignaturas aprobadas.`)) {
        students[currentStudentId].approved = [];
        saveStudents();
        renderCurriculum();
        updateProgress();
      }
    }

    function init() {
      if (Object.keys(students).length === 0) {
        students['11111111-1'] = { name: 'Estudiante Ejemplo', approved: [] };
      }
      currentStudentId = Object.keys(students)[0];
      populateStudentSelector();
      renderCurriculum();
      updateProgress();
    }

    init();

  </script>

</body>
</html>
